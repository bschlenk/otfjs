import{a as d,t as j,b as W,g as G,c as F,p as E,d as $,s as Z,e as _,Z as L,r as V,f as J,h as K,E as q,i as Q,R as H,j as T,l as k,k as tt,m as et,W as st,n as x,o as ot}from"./index-DYcLSRA5.js";class v{data;view;offset=0;maxOffset=0;constructor(t=1024){this.data=new ArrayBuffer(t),this.view=new DataView(this.data)}get length(){return Math.max(this.offset,this.maxOffset)}get byteLength(){return this.length}get capacity(){return this.data.byteLength}toBuffer(){return new Uint8Array(this.data,0,this.length)}u8(t){this.maybeResize(1),this.view.setUint8(this.offset,t),this.offset+=1}i8(t){this.maybeResize(1),this.view.setInt8(this.offset,t),this.offset+=1}u16(t){this.maybeResize(2),this.view.setUint16(this.offset,t),this.offset+=2}i16(t){this.maybeResize(2),this.view.setInt16(this.offset,t),this.offset+=2}u24(t){this.maybeResize(3);const n=new ArrayBuffer(4);new DataView(n).setUint32(0,t);const e=new Uint8Array(n);this.view.setUint8(this.offset,e[1]),this.view.setUint8(this.offset+1,e[2]),this.view.setUint8(this.offset+2,e[3]),this.offset+=3}u32(t){this.maybeResize(4),this.view.setUint32(this.offset,t),this.offset+=4}i32(t){this.maybeResize(4),this.view.setInt32(this.offset,t),this.offset+=4}i64(t){this.maybeResize(8),this.view.setBigInt64(this.offset,t),this.offset+=8}f2dot14(t){d(t>=-2&&t<2,"f2dot14 must be between -2 and 2"),this.u16(j(t))}date(t){this.i64(W(t))}tag(t){d(t.length===4,"Tag must be 4 characters long"),this.maybeResize(4),this.u8(t.charCodeAt(0)),this.u8(t.charCodeAt(1)),this.u8(t.charCodeAt(2)),this.u8(t.charCodeAt(3))}utf16(t){for(let n=0,e=t.length;n<e;++n)this.u16(t.charCodeAt(n))}skip(t){this.maybeResize(t),this.offset+=t}pad(t){const n=G(this.length,t);n&&this.skip(n)}buffer(t,n=0){const e=t instanceof v?t.toBuffer():new Uint8Array(t);let a=e.byteLength;a!==0&&(a+=n?G(this.offset+a,n):0,this.maybeResize(a),new Uint8Array(this.data).set(e,this.offset),this.offset+=a)}at(t,n){const e=this.offset;this.offset=t,n(this);const a=this.offset;return this.maxOffset=this.length,this.offset=e,a-t}checksum(){return F(new Uint8Array(this.data))}maybeResize(t){let n=this.capacity;if(this.offset+t<=n)return;for(;this.offset+t>n;)n*=2;const e=new ArrayBuffer(n);new Uint8Array(e).set(new Uint8Array(this.data)),this.data=e,this.view=new DataView(this.data)}}function nt(o){let t=12,n=0;for(const s of Object.values(o.tables))t+=16,n+=E(s.byteLength,4);const e=new v(t+n),a=Object.keys(o.tables).sort(),f=a.length,i=2**Math.floor(Math.log2(f))*16;e.u32(o.sfntVersion??1330926671),e.u16(f),e.u16(i),e.u16(Math.floor(Math.log2(f))),e.u16(f*16-i);let u=0;for(const s of a){const r=o.tables[s],h=t,l=r.byteLength;s==="head"&&($(r).setUint32(8,0),u=h);const b=F(r);t+=E(l,4),e.tag(s),e.u32(b),e.u32(h),e.u32(l)}for(const s of a){const r=o.tables[s];e.buffer(r,4)}const c=e.checksum();return e.at(u+8,s=>s.u32(2981146554-c)),e.toBuffer()}function at(o,t){const n=new v;for(let e=0;e<o.length;++e){const a=o[e];switch(t.push(n.length),a.type){case"simple":it(n,a);break;case"composite":ft(n,a);break}n.pad(4)}return t.push(n.length),n.toBuffer()}function it(o,t){if(t.endPtsOfContours.length===0&&t.instructions.length===0)return;o.i16(t.endPtsOfContours.length),D(o,t);for(const c of t.endPtsOfContours)o.u16(c);o.u16(t.instructions.length),o.buffer(t.instructions);const n=[],e=[],a=[];let f=L;for(const c of t.points){const s=_(0);s.onCurvePoint=c.onCurve,s.contoursOverlap=t.contoursOverlap;const{x:r,y:h}=Z(c,f);if(r===0)s.xIsSameOrPositiveXShortVector=!0;else{const l=Math.abs(r);l<256?(s.xShortVector=!0,s.xIsSameOrPositiveXShortVector=r>=0,e.push(l)):e.push(r)}if(h===0)s.yIsSameOrPositiveYShortVector=!0;else{const l=Math.abs(h);l<256?(s.yShortVector=!0,s.yIsSameOrPositiveYShortVector=h>=0,a.push(l)):a.push(h)}n.push(s),f=c}const i=[];for(const c of n){const s=i[i.length-1];s&&s.flags.value===c.value?s.repeat++:i.push({flags:c,repeat:0})}for(const{flags:c,repeat:s}of i)s&&(c.repeat=!0),o.u8(c.value),s&&o.u8(s);const u=c=>{c<0||c>255?o.i16(c):o.u8(c)};e.forEach(u),a.forEach(u)}function ft(o,t){o.i16(-1),D(o,t);for(const{flags:n,glyphIndex:e,arg1:a,arg2:f,extra:i}of t.components)o.u16(n.value),o.u16(e),n.arg1And2AreWords?n.argsAreXYValues?(o.i16(a),o.i16(f)):(o.u16(a),o.u16(f)):n.argsAreXYValues?(o.i8(a),o.i8(f)):(o.u8(a),o.u8(f)),n.weHaveAScale?(d(i.length===1,"Invalid extra array for weHaveAScale"),o.f2dot14(i[0])):n.weHaveAnXAndYScale?(d(i.length===2,"Invalid extra array for weHaveAnXAndYScale"),o.f2dot14(i[0]),o.f2dot14(i[1])):n.weHaveATwoByTwo?(d(i.length===4,"Invalid extra array for weHaveATwoByTwo"),o.f2dot14(i[0]),o.f2dot14(i[1]),o.f2dot14(i[2]),o.f2dot14(i[3])):d(i.length===0,"Extra array should be empty")}function D(o,t){o.i16(t.xMin),o.i16(t.yMin),o.i16(t.xMax),o.i16(t.yMax)}function rt(o,t){const n=new v;if(t===0)for(const e of o)n.u16(e/2);else for(const e of o)n.u32(e);return n.toBuffer()}function ct(o){const{numGlyphs:t,indexFormat:n,nContourStream:e,nPointsStream:a,flagStream:f,glyphStream:i,compositeStream:u,bboxBitmap:c,bboxStream:s,instructionStream:r,overlapSimpleBitmap:h}=ut(o),l=()=>r.u8Array(i.u16225()),b=()=>({xMin:s.i16(),yMin:s.i16(),xMax:s.i16(),yMax:s.i16()}),m=[];for(let g=0;g<t;g++){const w=e.i16(),A=V(c,g);switch(w){case 0:{d(!A,"Empty glyph should not have explicit bbox"),m.push(Q());break}case-1:{d(A,"Composite glyph must have explicit bbox");const C=[];let p,S=!1;do p=K(u),C.push(p),S||=p.flags.weHaveInstructions;while(p.flags.moreComponents);const M=S?l():q,B=b();m.push({type:"composite",...B,components:C,instructions:M});break}default:{const C=a.array(w,O=>O.u16225()),{endPtsOfContours:p,nPoints:S}=lt(C),M=f.u8Array(S),B=[];let R={...L,onCurve:!0},z=1/0,P=1/0,U=-1/0,I=-1/0;for(let O=0;O<S;O++){const X=M[O],y=ht(X,i);Object.assign(y,J(R,y)),R=y,B.push(y),A||(z=Math.min(z,y.x),P=Math.min(P,y.y),U=Math.max(U,y.x),I=Math.max(I,y.y))}A&&({xMin:z,yMin:P,xMax:U,yMax:I}=b());const Y=l(),N=h!=null&&V(h,g);m.push({type:"simple",xMin:z,yMin:P,xMax:U,yMax:I,endPtsOfContours:p,instructions:Y,points:B,contoursOverlap:N});break}}}return{glyphs:m,indexFormat:n}}function ut(o){const t=new H(o);t.skip(2);const n=t.u16(),e=t.u16(),a=4*Math.floor((e+31)/32),f=t.u16();d(f===0||f===1,`Invalid index format ${f}`);const i=t.u32(),u=t.u32(),c=t.u32(),s=t.u32(),r=t.u32(),h=t.u32(),l=t.u32(),b=t.stream(i),m=t.stream(u),g=t.stream(c),w=t.stream(s),A=t.stream(r),C=t.u8Array(a),p=t.stream(h),S=t.stream(l),M=n&1?t.u8Array(a):null;return{numGlyphs:e,indexFormat:f,nContourStream:b,nPointsStream:m,flagStream:g,glyphStream:w,compositeStream:A,bboxBitmap:C,bboxStream:p,instructionStream:S,overlapSimpleBitmap:M}}function lt(o){const t=[];let n=0;for(const e of o)n+=e,t.push(n-1);return{endPtsOfContours:t,nPoints:n}}function ht(o,t){const n=!(o>>>7&1),e=o&127;let a=0,f=0,i=0,u=0,c=!1,s=!1;if(e>=20&&(s=(e&1)===0,c=(e>>>1&1)===0),e<10)f=t.u8(),u=256*(e>>>1),c=(e&1)===0;else if(e<20)a=t.u8(),i=256*((e>>>1)-5),s=(e&1)===0;else if(e<36){const r=t.u8();a=T(r),f=k(r),i=1,u=1+((e>>>2)-5)*16}else if(e<52){const r=t.u8();a=T(r),f=k(r),i=17,u=1+((e>>>2)-9)*16}else if(e<68){const r=t.u8();a=T(r),f=k(r),i=33,u=1+((e>>>2)-13)*16}else if(e<84){const r=t.u8();a=T(r),f=k(r),i=49,u=1+((e>>>2)-17)*16}else if(e<96)a=t.u8(),f=t.u8(),i=1,u=1+((e>>>2)-21)*256;else if(e<108)a=t.u8(),f=t.u8(),i=257,u=1+((e>>>2)-24)*256;else if(e<120)a=t.u8(),f=t.u8(),i=513,u=1+((e>>>2)-27)*256;else if(e<124){const r=t.u24();a=tt(r),f=et(r)}else a=t.u16(),f=t.u16();return a=(a+i)*(s?-1:1),f=(f+u)*(c?-1:1),{x:a,y:f,onCurve:n}}const mt=["cmap","head","hhea","hmtx","maxp","name","OS/2","post","cvt ","fpgm","glyf","loca","prep","CFF ","VORG","EBDT","EBLC","gasp","hdmx","kern","LTSH","PCLT","VDMX","vhea","vmtx","BASE","GDEF","GPOS","GSUB","EBSC","JSTF","MATH","CBDT","CBLC","COLR","CPAL","SVG ","sbix","acnt","avar","bdat","bloc","bsln","cvar","fdsc","feat","fmtx","fvar","gvar","hsty","just","lcar","mort","morx","opbd","prop","trak","Zapf","Silf","Glat","Gloc","Feat","Sill"];function bt(o){const t=new H(o);t.u32()!==st&&x("Invalid WOFF2 signature"),t.u32(),t.u32();const n=t.u16();t.skip(2),t.u32(),t.u32(),t.u16(),t.u16(),t.u32(),t.u32(),t.u32(),t.u32(),t.u32();const e=t.array(n,()=>{const s=t.u8(),r=s&63,h=s>>>6&3,l=r===63?t.tag():mt[r],b=t.uBase128(),m=l==="glyf"||l==="loca"?h===3:h===0,g=m?b:t.uBase128();return{tag:l,transform:h,isNullTransform:m,length:g}}),a=ot(new Uint8Array(t.data,t.offset));d(a.length===e.reduce((s,r)=>s+r.length,0),"Unexpected decompressed stream size");const f=[];let i=!1,u=0;const c={};for(const s of e){const r=new Uint8Array(a.buffer,u,s.length);if(u+=s.length,s.isNullTransform){c[s.tag]=r;continue}switch(s.tag){case"glyf":{s.transform!==0&&x(`Unrecognized glyf transform ${s.transform}`),i&&x("Encountered loca table before glyf table");const{glyphs:h,indexFormat:l}=ct(r);c[s.tag]=at(h,f),c.loca=rt(f,l);break}case"loca":{s.transform!==0&&x(`Unrecognized loca transform ${s.transform}`),i=!0;break}case"hmtx":{s.transform!==1&&x(`Unrecognized hmtx transform ${s.transform}`),x("TODO: decode hmtx transform 1");break}default:x(`Unexpected transform ${s.transform} for table ${s.tag}`)}}return f.length&&!i&&x("Expected entry for loca table after glyf table"),nt({tables:c})}export{bt as decodeWoff2};
